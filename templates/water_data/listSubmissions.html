<html>

{% load bootstrap3 %}
{% bootstrap_css %} 
{% bootstrap_javascript %}


<style>
h3 {
	padding-left:10px;
}


.avina_img {
	text-align:center;
	position:absolute;
	bottom:5px;
	width:100%;
}

img {
	width:156px;
	height:73px;
	position:relative;
}

table {
	background-color:#E6EEF5;
}


</style>


</style>

<div>
	<h3> Survey: {{ title }} </h3>
</div>

<br>

<table class ="table table-bordered">
	<thead>
		<tr>
			<th scope ="col">OCSA Name</th>
			<th scope ="col">Submission Time</th>
			<th scope ="col">Dashboard</th>
			<th scope ="col">Photos</th>
				
		</tr>
	</thead>
	
	<tbody>
		{% for key, value in surveys.items %}
		<tr>
			<td>{{ value.ocsa_name }}</a></td>
			<td>{{ value.submission_time }}</a></td>
			<td>
				<a href="{{ url }}xlsDownload/{{ value.submission_id }}">Download</a></td>
			{% if value.has_photos %}
      <td>
        <a href="#" onclick='downloadPhotos("{{ url }}", "{{ value.submission_id }}")'>Download</a>
        <div id="spinner{{ value.submission_id}}"></div>
      </td>
			{% endif %}
		</tr>
		{% endfor %}
		
	</tbody>
</table>

<div class="avina_img"><img src = http://www.avina.net/esp/wp-content/uploads/2013/02/logo_avina.jpg></div>

<script>
  function downloadPhotos(url_base, submission_id) {
    var initialUrl = url_base + "photosStart/" + submission_id;
    var initialRequest = new XMLHttpRequest();
    var task_id = -1;
    initialRequest.onreadystatechange = function() {
      if (task_id == -1) {
        task_id = JSON.parse(initialRequest.responseText).task_id;
        var checkUrl = "/surveydata/cleanwater/photosCheck/" + task_id;
        var finishUrl = "/surveydata/cleanwater/photosFinish/" + task_id;
        var checkInterval = setInterval(function() {
          var checkRequest = new XMLHttpRequest();
          checkRequest.onreadystatechange = function() {
            ready = JSON.parse(checkRequest.responseText).ready;
            if (ready) {
              window.location = finishUrl;
            }
          };
          checkRequest.open('GET', checkUrl, true);
          checkRequest.send();
        }, 100);
      };
    }
    initialRequest.open('GET', initialUrl, true);
    initialRequest.send();
  }
</script>

</html>
